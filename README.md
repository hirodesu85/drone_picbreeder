# Drone Picbreeder

Picbreeder（インタラクティブな進化計算を用いたアート生成ツール）のドローンショー版です。ユーザーが好みのパターンを選択することで、ドローンの3D飛行軌道を進化的に生成します。

## 主な機能

- **インタラクティブ進化**: ユーザーが好みのパターンを選択しながら、ドローンショーのパターンを進化させる
- **3D軌道生成**: 進化計算により、ドローンの飛行経路を生成
- **リアルタイム可視化**: 生成されたパターンを3Dで確認可能

## 技術スタック

### フロントエンド
- **Three.js** - 3Dビジュアライゼーション

### バックエンド
- **Python** - メイン言語
- **FastAPI** - Web APIフレームワーク
- **NEAT (NeuroEvolution of Augmenting Topologies)** - 進化計算アルゴリズム
- **CPPN (Compositional Pattern Producing Networks)** - パターン生成ネットワーク

## 進化計算システムの設計

### CPPN仕様

**入力（4次元）**:
- `x, y, z`: ドローンの相対位置（原点からの座標）
- `d`: 原点からの距離 (d = √(x² + y² + z²))

**出力（6次元）**:
- `vx, vy, vz`: ドローンの速度ベクトル
- `r, g, b`: ドローンの色（RGB）

**その他の設定**:
- ドローン台数: 50台（固定）

シミュレーション設定の詳細（初期位置、空間制約、積分方法など）は実装時に追加します。

### 進化の流れ（インタラクティブ進化）

本システムはPicbreederスタイルのインタラクティブ進化を採用しています。

1. **初期集団の生成**: 12個体のランダムなCPPNを生成
2. **パターン表示**: 各CPPNからドローンの飛行パターンを生成し、3Dで可視化
3. **ユーザー選択**: ユーザーが好みのパターンを選択（複数選択可）
4. **進化**: 選択された個体を親として、交叉・突然変異により次世代を生成
5. **繰り返し**: 2〜4を繰り返し、パターンを洗練

選択された個体はそのまま次世代に引き継がれ（エリート保存）、残りの個体は選択された親から生成されます。

#### 進化オペレータの詳細

**親選択**:
- ユーザーが選択した個体（適応度 > 0）のみが親候補になる
- 親候補からランダムに2個体を選択して交叉

**交叉**:
- NEAT標準の交叉を使用
- 適応度が高い親の構造（ノード・接続）を優先的に継承

**突然変異**:
各突然変異は独立した確率で発生します（複数同時に起きることも、全く起きないこともあり得ます）。

*パラメータ変異*（各接続・ノードに対して個別に判定）:

| パラメータ | 確率 | 説明 |
|-----------|------|------|
| weight_mutate_rate | 80% | 接続の重みを変更 |
| bias_mutate_rate | 70% | ノードのバイアスを変更 |
| activation_mutate_rate | 20% | 活性化関数を変更 |

*構造変異*（ゲノム全体に対して各種類を個別に判定）:

| パラメータ | 確率 | 説明 |
|-----------|------|------|
| conn_add_prob | 50% | 新しい接続を追加 |
| conn_delete_prob | 30% | 接続を削除 |
| node_add_prob | 60% | 新しいノードを追加 |
| node_delete_prob | 30% | ノードを削除 |

詳細な設定は `backend/config/neat_config.txt` を参照してください。

### 制約（ドローンショーの物理的制約）

実際のドローンショーで実現可能なパターンを生成するため、以下の制約を設けています。

| 制約 | 値 |
|------|-----|
| 飛行区域 X | -8.5 〜 8.5 m |
| 飛行区域 Y | -8.5 〜 8.5 m |
| 飛行区域 Z（高度） | -6.5 〜 6.5 m |
| 最大水平速度 | 5.0 m/s |
| 最大垂直速度 | 2.5 m/s |
| ドローン間最小距離 | 0.5 m |

### 制約の保証方法

すべての個体が制約を満たすことを保証するため、棄却サンプリングを採用しています。

- **初期集団**: 制約を満たすまで新しいランダムゲノムを生成（最大100回リトライ）
- **進化時**: 制約を満たすまで同じ親から交叉・突然変異をやり直し（最大100回リトライ）

これにより、ユーザーに表示されるすべてのパターンは常に制約を満たしています。

## ドローンショーデータ形式

ドローンショーのアニメーションデータはJSON形式で定義されます。

### データ構造

```json
{
  "id": 0,
  "frames": [
    {
      "t": 0.0,
      "drones": [
        { "x": 0.0, "y": 0.0, "z": 0.0, "r": 127, "g": 255, "b": 127 },
        ...
      ]
    },
    ...
  ]
}
```

### フィールド説明

- **id**: パターンの個体ID（進化計算で使用）
- **frames**: 時系列順のフレーム配列
  - **t**: フレームの時刻（秒）
  - **drones**: 各ドローンの状態配列
    - **x, y, z**: ドローンの3D空間上の位置（メートル）
    - **r, g, b**: ドローンの色（RGB、各0-255）

### アニメーション仕様

- **フレームレート**: 25fps（固定）
- **フレーム間隔**: 1/25秒 = 0.04秒
- **座標系**: 3D直交座標系（中心が原点）

### サンプルデータ

現在のデモでは、5機のドローンが円形軌道で回転するパターンを使用しています（`frontend/mock.json`）。

## プロジェクト構造（予定）

```
drone_picbreeder/
├── frontend/     # Three.jsベースのフロントエンド
├── backend/      # FastAPIベースのバックエンド
└── README.md
```

## 開発環境のセットアップ

### バックエンド

1. backendディレクトリに移動
   ```bash
   cd backend
   ```

2. Pythonの仮想環境を作成
   ```bash
   python3 -m venv venv
   ```

3. 仮想環境を有効化
   ```bash
   source venv/bin/activate
   ```

4. 依存関係をインストール
   ```bash
   pip install -r requirements.txt
   ```

5. サーバーを起動
   ```bash
   python -m uvicorn main:app --reload
   ```

6. ブラウザでアクセス
   - API: http://localhost:8000/api/health
   - Swagger UI: http://localhost:8000/docs

### フロントエンド

**前提条件**: バックエンドサーバーが起動している必要があります（`http://localhost:8000`）

1. frontendディレクトリに移動
   ```bash
   cd frontend
   ```

2. HTTPサーバーを起動
   ```bash
   python -m http.server 3000
   ```

3. ブラウザでアクセス
   - http://localhost:3000

## 開発状況

現在はプロジェクトの初期段階です。実装が進むにつれて、このREADMEも更新していきます。
